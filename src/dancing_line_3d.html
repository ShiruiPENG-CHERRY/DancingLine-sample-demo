// Dancing Line 3D Game for Source Academy
// Using Three.js CDN for 3D graphics

/* ---------------------------------------------------------------
   1Ô∏è‚É£  Dynamically load Three.js, then start the game
---------------------------------------------------------------- */
(function loadThree() {
  const tag = document.createElement('script');
  tag.src = 'https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js';
  tag.onload = initDancingLine;
  tag.onerror = () => console.error('Failed to load Three.js from CDN');
  document.head.appendChild(tag);
})();

/* ---------------------------------------------------------------
   2Ô∏è‚É£  Game State & Globals (Source Academy friendly)
---------------------------------------------------------------- */
let scene = null;
let camera = null;
let renderer = null;
let container = null;
let gameContainer = null;

// Game objects
let dancingLine = null;
let linePath = [];
let obstacles = [];
let gems = [];
let platforms = [];

// Game state
let gameState = 'menu'; // 'menu', 'playing', 'paused', 'gameOver', 'success'
let score = 0;
let level = 1;
let linePosition = { x: 0, y: 0, z: 0 };
let lineDirection = 'forward';
let gameSpeed = 0.05;
let cameraDistance = 10;

// Audio system
let audioContext = null;
let backgroundMusic = null;
let musicGain = null;
let isMusicPlaying = false;
let musicVolume = 0.5;

// UI elements
let uiOverlay = null;
let scoreElement = null;
let menuElement = null;
let musicControls = null;
let instructionModal = null;
let volumeModal = null;
let successModal = null;

/* ---------------------------------------------------------------
   3Ô∏è‚É£  Initialize Dancing Line Game
---------------------------------------------------------------- */
function initDancingLine() {
  createGameContainer();
  setupThreeJS();
  setupAudio();
  createUI();
  createGameWorld();
  setupControls();
  startMenuState();
  animate();
  
  display("üéÆ Dancing Line 3D loaded! Click the game area to play!");
}

/* ---------------------------------------------------------------
   4Ô∏è‚É£  Setup Audio System
---------------------------------------------------------------- */
function setupAudio() {
  try {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    
    musicGain = audioContext.createGain();
    musicGain.connect(audioContext.destination);
    musicGain.gain.value = musicVolume;
    
    createBackgroundMusic();
  } catch (error) {
    console.log("Audio not supported:", error);
  }
}

function createBackgroundMusic() {
  if (!audioContext) return;
  
  const oscillator1 = audioContext.createOscillator();
  const oscillator2 = audioContext.createOscillator();
  const filter = audioContext.createBiquadFilter();
  const delay = audioContext.createDelay();
  const feedback = audioContext.createGain();
  
  oscillator1.type = 'sine';
  oscillator1.frequency.setValueAtTime(220, audioContext.currentTime);
  
  oscillator2.type = 'triangle';
  oscillator2.frequency.setValueAtTime(110, audioContext.currentTime);
  
  filter.type = 'lowpass';
  filter.frequency.setValueAtTime(800, audioContext.currentTime);
  
  delay.delayTime.setValueAtTime(0.3, audioContext.currentTime);
  feedback.gain.setValueAtTime(0.4, audioContext.currentTime);
  
  oscillator1.connect(filter);
  oscillator2.connect(filter);
  filter.connect(delay);
  delay.connect(feedback);
  feedback.connect(delay);
  delay.connect(musicGain);
  filter.connect(musicGain);
  
  backgroundMusic = { oscillator1, oscillator2 };
}

function toggleMusic() {
  if (!audioContext) return;
  
  if (isMusicPlaying) {
    stopMusic();
  } else {
    playMusic();
  }
}

function playMusic() {
  if (!audioContext || !backgroundMusic) return;
  
  try {
    if (audioContext.state === 'suspended') {
      audioContext.resume();
    }
    
    backgroundMusic.oscillator1.start();
    backgroundMusic.oscillator2.start();
    isMusicPlaying = true;
    
    const musicBtn = document.getElementById('musicToggle');
    if (musicBtn) musicBtn.textContent = 'üîä';
  } catch (error) {
    createBackgroundMusic();
    if (backgroundMusic) {
      backgroundMusic.oscillator1.start();
      backgroundMusic.oscillator2.start();
      isMusicPlaying = true;
    }
  }
}

function stopMusic() {
  if (!backgroundMusic) return;
  
  try {
    backgroundMusic.oscillator1.stop();
    backgroundMusic.oscillator2.stop();
    isMusicPlaying = false;
    
    createBackgroundMusic();
    
    const musicBtn = document.getElementById('musicToggle');
    if (musicBtn) musicBtn.textContent = 'üîá';
  } catch (error) {
    console.log("Error stopping music:", error);
  }
}

function setMusicVolume(volume) {
  musicVolume = Math.max(0, Math.min(1, volume));
  if (musicGain) {
    musicGain.gain.setValueAtTime(musicVolume, audioContext.currentTime);
  }
  const volumeDisplay = document.getElementById('volumeDisplay');
  if (volumeDisplay) {
    volumeDisplay.textContent = `${Math.round(volume * 100)}%`;
  }
}

/* ---------------------------------------------------------------
   5Ô∏è‚É£  Create Game Container
---------------------------------------------------------------- */
function createGameContainer() {
  container = document.createElement('div');
  container.style.position = 'fixed';
  container.style.left = '0';
  container.style.top = '0';
  container.style.width = '100%';
  container.style.height = '100vh';
  container.style.zIndex = '9999';
  container.style.background = 'linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)';
  document.body.appendChild(container);

  gameContainer = document.createElement('div');
  gameContainer.style.position = 'absolute';
  gameContainer.style.left = '0';
  gameContainer.style.top = '0';
  gameContainer.style.width = '100%';
  gameContainer.style.height = '100%';
  container.appendChild(gameContainer);
}

/* ---------------------------------------------------------------
   6Ô∏è‚É£  Setup Three.js Scene
---------------------------------------------------------------- */
function setupThreeJS() {
  scene = new THREE.Scene();
  scene.fog = new THREE.Fog(0x1a1a2e, 50, 100);

  camera = new THREE.PerspectiveCamera(
    75,
    container.clientWidth / container.clientHeight,
    0.1,
    1000
  );
  camera.position.set(0, 5, cameraDistance);
  camera.lookAt(0, 0, 0);

  renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setSize(container.clientWidth, container.clientHeight);
  renderer.setClearColor(0x1a1a2e, 1);
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  gameContainer.appendChild(renderer.domElement);

  const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
  scene.add(ambientLight);

  const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
  directionalLight.position.set(10, 10, 5);
  directionalLight.castShadow = true;
  directionalLight.shadow.mapSize.width = 2048;
  directionalLight.shadow.mapSize.height = 2048;
  scene.add(directionalLight);

  window.addEventListener('resize', onWindowResize);
}

/* ---------------------------------------------------------------
   7Ô∏è‚É£  Create UI Overlay
---------------------------------------------------------------- */
function createUI() {
  uiOverlay = document.createElement('div');
  uiOverlay.style.position = 'absolute';
  uiOverlay.style.top = '0';
  uiOverlay.style.left = '0';
  uiOverlay.style.width = '100%';
  uiOverlay.style.height = '100%';
  uiOverlay.style.pointerEvents = 'none';
  uiOverlay.style.fontFamily = 'Arial, sans-serif';
  uiOverlay.style.color = '#00ffff';
  container.appendChild(uiOverlay);

  scoreElement = document.createElement('div');
  scoreElement.style.position = 'absolute';
  scoreElement.style.top = '20px';
  scoreElement.style.left = '20px';
  scoreElement.style.fontSize = '24px';
  scoreElement.style.fontWeight = 'bold';
  scoreElement.style.textShadow = '0 0 10px rgba(0, 255, 255, 0.8)';
  scoreElement.innerHTML = 'Score: 0<br>Level: 1';
  uiOverlay.appendChild(scoreElement);

  createMusicControls();
  createMenu();
  createInstructionModal();
  createVolumeModal();
  createSuccessModal();
}

function createMusicControls() {
  musicControls = document.createElement('div');
  musicControls.style.position = 'absolute';
  musicControls.style.top = '20px';
  musicControls.style.right = '20px';
  musicControls.style.pointerEvents = 'auto';
  musicControls.style.display = 'flex';
  musicControls.style.gap = '15px';
  musicControls.style.alignItems = 'center';
  
  const musicToggle = document.createElement('button');
  musicToggle.id = 'musicToggle';
  musicToggle.textContent = 'üîá';
  musicToggle.style.cssText = `
    background: linear-gradient(145deg, rgba(255, 215, 0, 0.3), rgba(255, 215, 0, 0.1));
    border: 2px solid #ffd700;
    color: #ffd700;
    padding: 10px;
    font-size: 1.5rem;
    border-radius: 50%;
    cursor: pointer;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
  `;
  
  musicToggle.addEventListener('click', toggleMusic);
  musicToggle.addEventListener('mouseenter', () => {
    musicToggle.style.transform = 'scale(1.1)';
    musicToggle.style.boxShadow = '0 0 15px rgba(255, 215, 0, 0.5)';
  });
  musicToggle.addEventListener('mouseleave', () => {
    musicToggle.style.transform = 'scale(1)';
    musicToggle.style.boxShadow = 'none';
  });
  
  const volumeButton = document.createElement('button');
  volumeButton.id = 'volumeButton';
  volumeButton.textContent = 'üéµ';
  volumeButton.style.cssText = `
    background: linear-gradient(145deg, rgba(0, 255, 255, 0.3), rgba(0, 255, 255, 0.1));
    border: 2px solid #00ffff;
    color: #00ffff;
    padding: 10px;
    font-size: 1.5rem;
    border-radius: 50%;
    cursor: pointer;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
  `;
  
  volumeButton.addEventListener('click', showVolumeModal);
  volumeButton.addEventListener('mouseenter', () => {
    volumeButton.style.transform = 'scale(1.1)';
    volumeButton.style.boxShadow = '0 0 15px rgba(0, 255, 255, 0.5)';
  });
  volumeButton.addEventListener('mouseleave', () => {
    volumeButton.style.transform = 'scale(1)';
    volumeButton.style.boxShadow = 'none';
  });
  
  musicControls.appendChild(musicToggle);
  musicControls.appendChild(volumeButton);
  uiOverlay.appendChild(musicControls);
}

function createMenu() {
  menuElement = document.createElement('div');
  menuElement.style.position = 'absolute';
  menuElement.style.top = '50%';
  menuElement.style.left = '50%';
  menuElement.style.transform = 'translate(-50%, -50%)';
  menuElement.style.textAlign = 'center';
  menuElement.style.pointerEvents = 'auto';
  menuElement.innerHTML = `
    <h1 style="font-size: 4rem; margin-bottom: 20px; text-shadow: 0 0 20px rgba(0, 255, 255, 0.8);">
      DANCING LINE
    </h1>
    <p style="font-size: 1.2rem; margin-bottom: 40px; color: #ff6b9d;">
      3D Edition - Source Academy
    </p>
    <button id="startBtn" style="
      background: linear-gradient(145deg, rgba(255, 107, 157, 0.3), rgba(255, 107, 157, 0.1));
      border: 2px solid #ff6b9d;
      color: #ff6b9d;
      padding: 15px 30px;
      font-size: 1.5rem;
      border-radius: 10px;
      cursor: pointer;
      margin: 10px;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    ">START GAME</button>
    <br>
    <button id="instructionsBtn" style="
      background: linear-gradient(145deg, rgba(0, 255, 255, 0.2), rgba(0, 255, 255, 0.1));
      border: 2px solid #00ffff;
      color: #00ffff;
      padding: 10px 20px;
      font-size: 1rem;
      border-radius: 10px;
      cursor: pointer;
      margin: 10px;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    ">INSTRUCTIONS</button>
  `;
  uiOverlay.appendChild(menuElement);

  const startBtn = menuElement.querySelector('#startBtn');
  const instructionsBtn = menuElement.querySelector('#instructionsBtn');
  
  startBtn.addEventListener('mouseenter', () => {
    startBtn.style.transform = 'scale(1.05)';
    startBtn.style.boxShadow = '0 0 20px rgba(255, 107, 157, 0.5)';
  });
  
  startBtn.addEventListener('mouseleave', () => {
    startBtn.style.transform = 'scale(1)';
    startBtn.style.boxShadow = 'none';
  });

  instructionsBtn.addEventListener('mouseenter', () => {
    instructionsBtn.style.transform = 'scale(1.05)';
    instructionsBtn.style.boxShadow = '0 0 20px rgba(0, 255, 255, 0.5)';
  });
  
  instructionsBtn.addEventListener('mouseleave', () => {
    instructionsBtn.style.transform = 'scale(1)';
    instructionsBtn.style.boxShadow = 'none';
  });

  startBtn.addEventListener('click', startGame);
  instructionsBtn.addEventListener('click', showInstructions);
}

function createInstructionModal() {
  instructionModal = document.createElement('div');
  instructionModal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(20px);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    pointer-events: auto;
  `;
  
  const modalContent = document.createElement('div');
  modalContent.style.cssText = `
    background: linear-gradient(135deg, rgba(26, 26, 46, 0.95), rgba(22, 33, 62, 0.95));
    border: 3px solid #00ffff;
    border-radius: 25px;
    padding: 50px;
    max-width: 800px;
    max-height: 85vh;
    overflow-y: auto;
    text-align: center;
    box-shadow: 0 0 60px rgba(0, 255, 255, 0.4);
    animation: modalPulse 2s ease-in-out infinite alternate;
    position: relative;
  `;
  
  modalContent.innerHTML = `
    <button id="closeModalX" style="
      position: absolute;
      top: 15px;
      right: 20px;
      background: none;
      border: none;
      color: #ff6b9d;
      font-size: 2rem;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    ">√ó</button>
    
    <h2 style="
      font-size: 3.5rem; 
      margin-bottom: 30px; 
      background: linear-gradient(45deg, #ff6b9d, #00ffff, #ffd700);
      background-size: 200% 200%;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradientShift 3s ease-in-out infinite;
      text-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
    ">
      üéØIGNITE YOUR DANCEüéØ
    </h2>
    
    <div style="
      font-size: 1.4rem; 
      line-height: 1.9; 
      margin-bottom: 40px; 
      color: #ffffff;
      text-shadow: 0 0 12px rgba(255, 255, 255, 0.4);
    ">
      <div style="
        background: linear-gradient(45deg, rgba(255, 107, 157, 0.15), rgba(0, 255, 255, 0.15));
        border-left: 4px solid #ff6b9d;
        border-radius: 15px;
        padding: 25px;
        margin: 25px 0;
        text-align: left;
      ">
        <h3 style="color: #ffd700; margin-bottom: 15px; font-size: 1.6rem;">üöÄ COMMAND THE COSMOS!</h3>
        <p><strong style="color: #00ffff;">WASD or Arrow Keys:</strong> Dance through the universe's twists and turns!</p>
        <p><strong style="color: #00ffff;">SPACE:</strong> Leap over obstacles with fearless grace!</p>
        <p><strong style="color: #00ffff;">P:</strong> Pause to strategize your next epic move!</p>
        <p><strong style="color: #00ffff;">ESC:</strong> Return to base, ready for another challenge!</p>
      </div>
      
      <div style="
        background: linear-gradient(45deg, rgba(255, 215, 0, 0.15), rgba(255, 107, 157, 0.15));
        border-left: 4px solid #ffd700;
        border-radius: 15px;
        padding: 25px;
        margin: 25px 0;
        text-align: left;
      ">
        <h3 style="color: #ff6b9d; margin-bottom: 15px; font-size: 1.6rem;">üí• RISE TO GLORY!</h3>
        <p>üéµ <strong>Sync with the rhythm!</strong> Let the beat fuel your soul!</p>
        <p>‚ö° <strong>Timing is your superpower!</strong> Strike at the perfect moment!</p>
        <p>üåü <strong>Seize the golden gems!</strong> Each one is a step toward legend!</p>
        <p>üî• <strong>Defy the odds!</strong> Dodge obstacles and claim your victory!</p>
      </div>
      
      <div style="
        background: linear-gradient(45deg, rgba(0, 255, 255, 0.2), rgba(255, 215, 0, 0.2));
        border: 2px solid rgba(255, 255, 255, 0.4);
        border-radius: 20px;
        padding: 30px;
        margin: 30px 0;
        animation: challengePulse 2s ease-in-out infinite alternate;
      ">
        <h3 style="
          color: #00ffff; 
          font-size: 2rem; 
          margin-bottom: 15px;
          text-shadow: 0 0 15px rgba(0, 255, 255, 0.8);
        ">
          ‚öîÔ∏è YOUR LEGEND BEGINS NOW! ‚öîÔ∏è
        </h3>
        <p style="font-size: 1.3rem; color: #ffd700; font-weight: bold;">
          Are you ready to carve your name among the stars?<br>
          Embrace the challenge and <span style="color: #ff6b9d;">DANCE TO DESTINY!</span>
        </p>
      </div>
    </div>
    
    <button id="closeModal" style="
      background: linear-gradient(145deg, rgba(255, 107, 157, 0.5), rgba(255, 107, 157, 0.3));
      border: 3px solid #ff6b9d;
      color: #ff6b9d;
      padding: 20px 50px;
      font-size: 1.4rem;
      font-weight: bold;
      border-radius: 30px;
      cursor: pointer;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      box-shadow: 0 0 25px rgba(255, 107, 157, 0.4);
      text-shadow: 0 0 10px rgba(255, 107, 157, 0.8);
    ">
      üéÆ LET'S CONQUER THE RHYTHM! üéÆ
    </button>
    
    <style>
      @keyframes modalPulse {
        0% { transform: scale(1); }
        100% { transform: scale(1.01); }
      }
      
      @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }
      
      @keyframes challengePulse {
        0% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
        100% { box-shadow: 0 0 40px rgba(255, 215, 0, 0.6); }
      }
    </style>
  `;
  
  const closeBtn = modalContent.querySelector('#closeModal');
  const closeXBtn = modalContent.querySelector('#closeModalX');
  
  closeBtn.addEventListener('click', hideInstructions);
  closeXBtn.addEventListener('click', hideInstructions);
  
  closeBtn.addEventListener('mouseenter', () => {
    closeBtn.style.transform = 'scale(1.1)';
    closeBtn.style.boxShadow = '0 0 40px rgba(255, 107, 157, 0.8)';
  });
  closeBtn.addEventListener('mouseleave', () => {
    closeBtn.style.transform = 'scale(1)';
    closeBtn.style.boxShadow = '0 0 25px rgba(255, 107, 157, 0.4)';
  });
  
  closeXBtn.addEventListener('mouseenter', () => {
    closeXBtn.style.background = 'rgba(255, 107, 157, 0.2)';
    closeXBtn.style.transform = 'scale(1.2)';
  });
  closeXBtn.addEventListener('mouseleave', () => {
    closeXBtn.style.background = 'none';
    closeXBtn.style.transform = 'scale(1)';
  });
  
  instructionModal.addEventListener('click', (e) => {
    if (e.target === instructionModal) {
      hideInstructions();
    }
  });
  
  instructionModal.appendChild(modalContent);
  container.appendChild(instructionModal);
}

function createVolumeModal() {
  volumeModal = document.createElement('div');
  volumeModal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(15px);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10001;
    pointer-events: auto;
  `;
  
  const modalContent = document.createElement('div');
  modalContent.style.cssText = `
    background: linear-gradient(135deg, rgba(26, 26, 46, 0.95), rgba(22, 33, 62, 0.95));
    border: 3px solid #00ffff;
    border-radius: 25px;
    padding: 40px;
    max-width: 500px;
    text-align: center;
    box-shadow: 0 0 50px rgba(0, 255, 255, 0.4);
    animation: modalPulse 2s ease-in-out infinite alternate;
    position: relative;
  `;
  
  modalContent.innerHTML = `
    <button id="closeVolumeModalX" style="
      position: absolute;
      top: 15px;
      right: 20px;
      background: none;
      border: none;
      color: #ff6b9d;
      font-size: 2rem;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    ">√ó</button>
    
    <h2 style="
      font-size: 2.5rem; 
      margin-bottom: 30px; 
      color: #00ffff;
      text-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
    ">
      üéµ AUDIO CONTROL
    </h2>
    
    <div style="
      background: linear-gradient(45deg, rgba(0, 255, 255, 0.1), rgba(255, 215, 0, 0.1));
      border: 2px solid rgba(0, 255, 255, 0.3);
      border-radius: 15px;
      padding: 30px;
      margin: 20px 0;
    ">
      <div style="
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin-bottom: 20px;
      ">
        <span style="font-size: 1.5rem;">üîà</span>
        <input type="range" id="volumeSlider" min="0" max="100" value="50" style="
          width: 200px;
          height: 8px;
          background: linear-gradient(to right, #00ffff, #ffd700);
          outline: none;
          border-radius: 4px;
          cursor: pointer;
          appearance: none;
          -webkit-appearance: none;
        ">
        <span style="font-size: 1.5rem;">üîä</span>
      </div>
      
      <div style="
        font-size: 1.2rem;
        color: #ffd700;
        margin-bottom: 20px;
      ">
        Volume: <span id="volumeDisplay">50%</span>
      </div>
      
      <div style="
        display: flex;
        justify-content: center;
        gap: 15px;
      ">
        <button id="muteBtn" style="
          background: linear-gradient(145deg, rgba(255, 107, 157, 0.3), rgba(255, 107, 157, 0.1));
          border: 2px solid #ff6b9d;
          color: #ff6b9d;
          padding: 10px 20px;
          font-size: 1rem;
          border-radius: 15px;
          cursor: pointer;
          backdrop-filter: blur(10px);
          transition: all 0.3s ease;
        ">üîá MUTE</button>
        
        <button id="maxVolumeBtn" style="
          background: linear-gradient(145deg, rgba(255, 215, 0, 0.3), rgba(255, 215, 0, 0.1));
          border: 2px solid #ffd700;
          color: #ffd700;
          padding: 10px 20px;
          font-size: 1rem;
          border-radius: 15px;
          cursor: pointer;
          backdrop-filter: blur(10px);
          transition: all 0.3s ease;
        ">üîä MAX</button>
      </div>
    </div>
    
    <button id="closeVolumeModal" style="
      background: linear-gradient(145deg, rgba(255, 107, 157, 0.5), rgba(255, 107, 157, 0.3));
      border: 3px solid #ff6b9d;
      color: #ff6b9d;
      padding: 20px 50px;
      font-size: 1.4rem;
      font-weight: bold;
      border-radius: 30px;
      cursor: pointer;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      box-shadow: 0 0 25px rgba(255, 107, 157, 0.4);
      text-shadow: 0 0 10px rgba(255, 107, 157, 0.8);
    ">
      SAVE & CLOSE
    </button>
    
    <style>
      @keyframes modalPulse {
        0% { transform: scale(1); }
        100% { transform: scale(1.01); }
      }
      
      #volumeSlider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        background: #00ffff;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
      }
      
      #volumeSlider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: #00ffff;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
      }
    </style>
  `;
  
  const closeBtn = modalContent.querySelector('#closeVolumeModal');
  const closeXBtn = modalContent.querySelector('#closeVolumeModalX');
  const volumeSlider = modalContent.querySelector('#volumeSlider');
  const muteBtn = modalContent.querySelector('#muteBtn');
  const maxVolumeBtn = modalContent.querySelector('#maxVolumeBtn');
  
  closeBtn.addEventListener('click', hideVolumeModal);
  closeXBtn.addEventListener('click', hideVolumeModal);
  
  closeBtn.addEventListener('mouseenter', () => {
    closeBtn.style.transform = 'scale(1.1)';
    closeBtn.style.boxShadow = '0 0 40px rgba(255, 107, 157, 0.8)';
  });
  closeBtn.addEventListener('mouseleave', () => {
    closeBtn.style.transform = 'scale(1)';
    closeBtn.style.boxShadow = '0 0 25px rgba(255, 107, 157, 0.4)';
  });
  
  closeXBtn.addEventListener('mouseenter', () => {
    closeXBtn.style.background = 'rgba(255, 107, 157, 0.2)';
    closeXBtn.style.transform = 'scale(1.2)';
  });
  closeXBtn.addEventListener('mouseleave', () => {
    closeXBtn.style.background = 'none';
    closeXBtn.style.transform = 'scale(1)';
  });
  
  volumeSlider.addEventListener('input', (e) => {
    const volume = e.target.value / 100;
    setMusicVolume(volume);
  });
  
  muteBtn.addEventListener('click', () => {
    setMusicVolume(0);
    volumeSlider.value = '0';
  });
  
  maxVolumeBtn.addEventListener('click', () => {
    setMusicVolume(1);
    volumeSlider.value = '100';
  });
  
  volumeModal.addEventListener('click', (e) => {
    if (e.target === volumeModal) {
      hideVolumeModal();
    }
  });
  
  volumeModal.appendChild(modalContent);
  container.appendChild(volumeModal);
}

function createSuccessModal() {
  successModal = document.createElement('div');
  successModal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(20px);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    pointer-events: auto;
  `;
  
  const modalContent = document.createElement('div');
  modalContent.style.cssText = `
    background: linear-gradient(135deg, rgba(26, 26, 46, 0.95), rgba(22, 33, 62, 0.95));
    border: 3px solid #ffd700;
    border-radius: 25px;
    padding: 50px;
    max-width: 600px;
    text-align: center;
    box-shadow: 0 0 60px rgba(255, 215, 0, 0.4);
    animation: modalPulse 2s ease-in-out infinite alternate;
    position: relative;
  `;
  
  modalContent.innerHTML = `
    <button id="closeSuccessModalX" style="
      position: absolute;
      top: 15px;
      right: 20px;
      background: none;
      border: none;
      color: #ff6b9d;
      font-size: 2rem;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    ">√ó</button>
    
    <h2 style="
      font-size: 3.5rem; 
      margin-bottom: 30px; 
      background: linear-gradient(45deg, #ffd700, #00ffff, #ff6b9d);
      background-size: 200% 200%;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradientShift 3s ease-in-out infinite;
      text-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
    ">
      üéâ LEVEL CONQUERED! üéâ
    </h2>
    
    <div style="
      font-size: 1.4rem; 
      line-height: 1.9; 
      margin-bottom: 40px; 
      color: #ffffff;
      text-shadow: 0 0 12px rgba(255, 255, 255, 0.4);
    ">
      <p style="font-size: 1.8rem; color: #ffd700; font-weight: bold;">
        You've mastered Level <span id="successLevel">${level}</span>!
      </p>
      <p style="margin: 20px 0;">
        Your score: <span id="successScore">${score}</span><br>
        You're a rhythm warrior! Keep dancing to the stars!
      </p>
      
      <div style="
        background: linear-gradient(45deg, rgba(255, 215, 0, 0.15), rgba(0, 255, 255, 0.15));
        border: 2px solid rgba(255, 255, 255, 0.4);
        border-radius: 20px;
        padding: 30px;
        margin: 30px 0;
        animation: challengePulse 2s ease-in-out infinite alternate;
      ">
        <p style="font-size: 1.3rem; color: #00ffff; font-weight: bold;">
          Ready for the next challenge? Your legend grows with every beat!
        </p>
      </div>
    </div>
    
    <button id="continueBtn" style="
      background: linear-gradient(145deg, rgba(255, 215, 0, 0.5), rgba(255, 215, 0, 0.3));
      border: 3px solid #ffd700;
      color: #ffd700;
      padding: 20px 50px;
      font-size: 1.4rem;
      font-weight: bold;
      border-radius: 30px;
      cursor: pointer;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      box-shadow: 0 0 25px rgba(255, 215, 0, 0.4);
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
    ">
      üåü CONTINUE TO GLORY!üåü
    </button>
    
    <style>
      @keyframes modalPulse {
        0% { transform: scale(1); }
        100% { transform: scale(1.01); }
      }
      
      @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }
      
      @keyframes challengePulse {
        0% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
        100% { box-shadow: 0 0 40px rgba(255, 215, 0, 0.6); }
      }
    </style>
  `;
  
  const closeBtn = modalContent.querySelector('#continueBtn');
  const closeXBtn = modalContent.querySelector('#closeSuccessModalX');
  
  closeBtn.addEventListener('click', () => {
    hideSuccessModal();
    startMenuState();
  });
  closeXBtn.addEventListener('click', () => {
    hideSuccessModal();
    startMenuState();
  });
  
  closeBtn.addEventListener('mouseenter', () => {
    closeBtn.style.transform = 'scale(1.1)';
    closeBtn.style.boxShadow = '0 0 40px rgba(255, 215, 0, 0.8)';
  });
  closeBtn.addEventListener('mouseleave', () => {
    closeBtn.style.transform = 'scale(1)';
    closeBtn.style.boxShadow = '0 0 25px rgba(255, 215, 0, 0.4)';
  });
  
  closeXBtn.addEventListener('mouseenter', () => {
    closeXBtn.style.background = 'rgba(255, 107, 157, 0.2)';
    closeXBtn.style.transform = 'scale(1.2)';
  });
  closeXBtn.addEventListener('mouseleave', () => {
    closeXBtn.style.background = 'none';
    closeXBtn.style.transform = 'scale(1)';
  });
  
  successModal.addEventListener('click', (e) => {
    if (e.target === successModal) {
      hideSuccessModal();
      startMenuState();
    }
  });
  
  successModal.appendChild(modalContent);
  container.appendChild(successModal);
}

/* ---------------------------------------------------------------
   8Ô∏è‚É£  UI Control Functions
---------------------------------------------------------------- */
function showInstructions() {
  instructionModal.style.display = 'flex';
  if (!isMusicPlaying) {
    playMusic();
  }
}

function hideInstructions() {
  instructionModal.style.display = 'none';
}

function showVolumeModal() {
  volumeModal.style.display = 'flex';
}

function hideVolumeModal() {
  volumeModal.style.display = 'none';
}

function showSuccessModal() {
  gameState = 'success';
  const successLevel = document.getElementById('successLevel');
  const successScore = document.getElementById('successScore');
  if (successLevel) successLevel.textContent = level;
  if (successScore) successScore.textContent = score;
  successModal.style.display = 'flex';
}

function hideSuccessModal() {
  successModal.style.display = 'none';
}

/* ---------------------------------------------------------------
   9Ô∏è‚É£  Create Game World
---------------------------------------------------------------- */
function createGameWorld() {
  createDancingLine();
  createPlatform(0, 0, 0, 20, 0.2, 2);
  generateLevel();
}

function createDancingLine() {
  const lineGeometry = new THREE.CylinderGeometry(0.1, 0.1, 1, 8);
  const lineMaterial = new THREE.MeshLambertMaterial({ 
    color: 0x00ffff,
    emissive: 0x002244
  });
  
  dancingLine = new THREE.Mesh(lineGeometry, lineMaterial);
  dancingLine.position.set(0, 0.6, 0);
  dancingLine.castShadow = true;
  scene.add(dancingLine);

  const glowGeometry = new THREE.CylinderGeometry(0.15, 0.15, 1.1, 8);
  const glowMaterial = new THREE.MeshBasicMaterial({ 
    color: 0x00ffff,
    transparent: true,
    opacity: 0.3
  });
  const glow = new THREE.Mesh(glowGeometry, glowMaterial);
  dancingLine.add(glow);
}

function createPlatform(x, y, z, width, height, depth) {
  const platformGeometry = new THREE.BoxGeometry(width, height, depth);
  const platformMaterial = new THREE.MeshLambertMaterial({ color: 0x444444 });
  
  const platform = new THREE.Mesh(platformGeometry, platformMaterial);
  platform.position.set(x, y, z);
  platform.receiveShadow = true;
  scene.add(platform);
  platforms.push(platform);
  
  return platform;
}

function createObstacle(x, y, z) {
  const obstacleGeometry = new THREE.BoxGeometry(1, 2, 1);
  const obstacleMaterial = new THREE.MeshLambertMaterial({ 
    color: 0xff4444,
    emissive: 0x220000
  });
  
  const obstacle = new THREE.Mesh(obstacleGeometry, obstacleMaterial);
  obstacle.position.set(x, y, z);
  obstacle.castShadow = true;
  scene.add(obstacle);
  obstacles.push(obstacle);
  
  return obstacle;
}

function createGem(x, y, z) {
  const gemGeometry = new THREE.OctahedronGeometry(0.3);
  const gemMaterial = new THREE.MeshLambertMaterial({ 
    color: 0xffd700,
    emissive: 0x444400
  });
  
  const gem = new THREE.Mesh(gemGeometry, gemMaterial);
  gem.position.set(x, y, z);
  gem.castShadow = true;
  scene.add(gem);
  gems.push(gem);
  
  return gem;
}

function generateLevel() {
  obstacles.forEach(obj => scene.remove(obj));
  gems.forEach(obj => scene.remove(obj));
  obstacles = [];
  gems = [];

  for (let i = 1; i <= 20; i++) {
    const z = -i * 3;
    
    if (i % 3 === 0) {
      createPlatform(Math.random() * 4 - 2, 0, z, 2, 0.2, 2);
    } else {
      createPlatform(0, 0, z, 6, 0.2, 2);
    }
    
    if (i > 2 && Math.random() > 0.7) {
      createObstacle(Math.random() * 4 - 2, 1, z);
    }
    
    if (Math.random() > 0.6) {
      createGem(Math.random() * 4 - 2, 1.5, z);
    }
  }
}

/* ---------------------------------------------------------------
   üîü  Game Control Functions
---------------------------------------------------------------- */
function startGame() {
  gameState = 'playing';
  menuElement.style.display = 'none';
  score = 0;
  level = 1;
  linePosition = { x: 0, y: 0.6, z: 0 };
  
  dancingLine.position.set(0, 0.6, 0);
  camera.position.set(0, 5, cameraDistance);
  
  updateScore();
  display("üéÆ Dancing Line started! Use ARROW KEYS or WASD to move, SPACE to jump!");
}

function pauseGame() {
  if (gameState === 'playing') {
    gameState = 'paused';
    display("‚è∏Ô∏è GAME PAUSED - Press P to resume");
  } else if (gameState === 'paused') {
    gameState = 'playing';
    display("‚ñ∂Ô∏è GAME RESUMED");
  }
}

function gameOver() {
  gameState = 'gameOver';
  display("üíÄ GAME OVER! Final Score: " + score);
  
  setTimeout(() => {
    menuElement.style.display = 'block';
    menuElement.querySelector('h1').textContent = 'GAME OVER';
    menuElement.querySelector('p').textContent = 'Final Score: ' + score;
  }, 2000);
}

function levelComplete() {
  gameState = 'success';
  display("üéâ LEVEL " + level + " COMPLETED! Score: " + score);
  showSuccessModal();
}

function updateScore() {
  scoreElement.innerHTML = `Score: ${score}<br>Level: ${level}`;
}

/* ---------------------------------------------------------------
   1Ô∏è‚É£1Ô∏è‚É£  Game Physics & Collision Detection
---------------------------------------------------------------- */
function updateGameLogic() {
  if (gameState !== 'playing') return;

  linePosition.z -= gameSpeed;
  dancingLine.position.z = linePosition.z;

  camera.position.z = linePosition.z + cameraDistance;
  camera.lookAt(linePosition.x, linePosition.y, linePosition.z);

  gems.forEach((gem, index) => {
    const distance = dancingLine.position.distanceTo(gem.position);
    if (distance < 0.8) {
      scene.remove(gem);
      gems.splice(index, 1);
      score += 10;
      updateScore();
      display("üíé Gem collected! +10 points");
    }
  });

  obstacles.forEach(obstacle => {
    const distance = dancingLine.position.distanceTo(obstacle.position);
    if (distance < 0.8) {
      gameOver();
    }
  });

  if (dancingLine.position.y < -5) {
    gameOver();
  }

  if (Math.abs(linePosition.z) > level * 60) {
    level++;
    score += 100;
    gameSpeed += 0.01;
    updateScore();
    generateLevel();
    levelComplete();
  }

  gems.forEach(gem => {
    gem.rotation.y += 0.05;
    gem.position.y += Math.sin(Date.now() * 0.001 + gem.position.x) * 0.01;
  });
}

/* ---------------------------------------------------------------
   1Ô∏è‚É£2Ô∏è‚É£  Input Controls
---------------------------------------------------------------- */
function setupControls() {
  document.addEventListener('keydown', handleKeyDown);
  document.addEventListener('keyup', handleKeyUp);
}

function handleKeyDown(event) {
  if (gameState !== 'playing') {
    if (event.code === 'KeyP') pauseGame();
    if (event.code === 'Escape') startMenuState();
    return;
  }

  switch (event.code) {
    case 'ArrowLeft':
    case 'KeyA':
      moveLineLeft();
      break;
    case 'ArrowRight':
    case 'KeyD':
      moveLineRight();
      break;
    case 'ArrowUp':
    case 'KeyW':
      moveLineUp();
      break;
    case 'ArrowDown':
    case 'KeyS':
      moveLineDown();
      break;
    case 'Space':
      event.preventDefault();
      jumpLine();
      break;
    case 'KeyP':
      pauseGame();
      break;
    case 'Escape':
      startMenuState();
      break;
  }
}

function handleKeyUp(event) {
  // Handle key releases if needed
}

function moveLineLeft() {
  if (linePosition.x > -3) {
    linePosition.x -= 0.5;
    dancingLine.position.x = linePosition.x;
  }
}

function moveLineRight() {
  if (linePosition.x < 3) {
    linePosition.x += 0.5;
    dancingLine.position.x = linePosition.x;
  }
}

function moveLineUp() {
  if (linePosition.y < 4) {
    linePosition.y += 0.3;
    dancingLine.position.y = linePosition.y;
  }
}

function moveLineDown() {
  if (linePosition.y > 0.6) {
    linePosition.y -= 0.3;
    dancingLine.position.y = linePosition.y;
  }
}

function jumpLine() {
  const originalY = dancingLine.position.y;
  dancingLine.position.y += 2;
  
  setTimeout(() => {
    dancingLine.position.y = originalY;
  }, 300);
}

/* ---------------------------------------------------------------
   1Ô∏è‚É£3Ô∏è‚É£  Menu State
---------------------------------------------------------------- */
function startMenuState() {
  gameState = 'menu';
  menuElement.style.display = 'block';
  menuElement.querySelector('h1').textContent = 'DANCING LINE';
  menuElement.querySelector('p').textContent = '3D Edition - Source Academy';
}

/* ---------------------------------------------------------------
   1Ô∏è‚É£4Ô∏è‚É£  Window Resize Handler
---------------------------------------------------------------- */
function onWindowResize() {
  const w = container.clientWidth;
  const h = container.clientHeight;

  renderer.setSize(w, h);
  camera.aspect = w / h;
  camera.updateProjectionMatrix();
}

/* ---------------------------------------------------------------
   1Ô∏è‚É£5Ô∏è‚É£  Main Animation Loop
---------------------------------------------------------------- */
function animate() {
  requestAnimationFrame(animate);
  
  updateGameLogic();
  
  renderer.render(scene, camera);
}

/* ---------------------------------------------------------------
   1Ô∏è‚É£6Ô∏è‚É£  Public API for Source Academy
---------------------------------------------------------------- */
function dancing_line_3d() {
  display("üéÆ Loading Dancing Line 3D...");
  display("A 3D dancing line game using Three.js");
  display("The game will appear in a full-screen overlay");
  return "Dancing Line 3D initialization started!";
}

function start_dancing_line() {
  if (gameState === 'menu') {
    startGame();
  } else {
    display("Game is already running!");
  }
}

function move_left() {
  moveLineLeft();
  return "Moved left";
}

function move_right() {
  moveLineRight();
  return "Moved right";
}

function move_up() {
  moveLineUp();
  return "Moved up";
}

function move_down() {
  moveLineDown();
  return "Moved down";
}

function jump() {
  jumpLine();
  return "Jumped!";
}

function pause_game() {
  pauseGame();
  return gameState === 'paused' ? "Game paused" : "Game resumed";
}

function get_game_status() {
  return {
    state: gameState,
    score: score,
    level: level,
    position: linePosition
  };
}

function close_game() {
  if (container && container.parentNode) {
    container.parentNode.removeChild(container);
    display("üéÆ Dancing Line 3D closed");
  }
  return "Game closed";
}

/* ---------------------------------------------------------------
   1Ô∏è‚É£7Ô∏è‚É£  Auto-start message
---------------------------------------------------------------- */
display("üéÆ Dancing Line 3D loaded successfully!");
display("Commands:");
display("‚Ä¢ dancing_line_3d() - Show game info");
display("‚Ä¢ start_dancing_line() - Quick start");
display("‚Ä¢ move_left(), move_right(), move_up(), move_down() - Manual controls");
display("‚Ä¢ jump() - Jump over obstacles");
display("‚Ä¢ pause_game() - Pause/resume");
display("‚Ä¢ get_game_status() - Check game state");
display("‚Ä¢ close_game() - Close the game");
display("");
display("üéØ The game will load automatically with full 3D graphics!");

dancing_line_3d;